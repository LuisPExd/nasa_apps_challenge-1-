<!doctype html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<title>Air Quality Index (AQI) Viewer</title>
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<style>
		/* Estilos generales */
		html, body, #map { height:100%; margin:0; padding:0; }
		body { font-family: 'Inter', sans-serif; }

		/* Nuevo Panel de Cabecera (T√≠tulo y Descripci√≥n) */
		#headerPanel {
			position: absolute;
			top: 10px;
			left: 10px;
			z-index: 1000;
			background: #ffffff;
			border-radius: 10px;
			padding: 12px 18px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.2);
			max-width: 400px;
			border-left: 5px solid #1f3a93; /* Un toque de color NASA */
			font-family: sans-serif;
			transition: all 0.3s ease;
		}
		#headerPanel h1 {
			font-size: 1.4rem;
			margin: 0;
			color: #1f3a93;
		}
		#headerPanel p {
			font-size: 0.8rem;
			color: #555;
			margin: 5px 0 0 0;
			line-height: 1.4;
		}

		/* Controles (Botones a la derecha) */
		.controls {
			position:absolute; top:10px; right:10px; z-index:1000;
			display:flex; flex-direction:column; gap:8px;
		}
		.custom-button, select {
			background:white; border:1px solid #ccc; border-radius:8px;
			font-family:sans-serif; padding:8px 12px; cursor:pointer;
			font-size:14px; box-shadow:0 1px 4px rgba(0,0,0,0.3);
			transition: background-color 0.2s;
			width: 100%; /* Asegura que los botones sean flexibles */
		}
		.custom-button:hover {
			background: #f4f4f4;
		}

		/* Panel de Indicadores (A la izquierda) */
		.indicators-panel {
			position:absolute; top:120px; left:10px; width:340px;
			max-height:85%; overflow-y:auto; background:white;
			border:1px solid #ccc; border-radius:8px; padding:10px 12px;
			box-shadow:0 2px 6px rgba(0,0,0,0.3); font-family:sans-serif;
			z-index:1100; display:none; scrollbar-width: thin;
		}
		/* Ajuste para m√≥vil en el panel de indicadores */
		@media (max-width: 600px) {
			.indicators-panel {
				width: calc(100% - 20px);
				max-width: 100%;
			}
			#headerPanel {
				max-width: 100%;
				width: calc(100% - 20px);
			}
		}

		/* Elementos internos del panel de indicadores */
		.indicators-close {
			position:absolute; top:5px; right:8px; background:#eee; border:none;
			border-radius:50%; width:24px; height:24px; cursor:pointer; font-weight:bold;
			line-height: 24px; text-align: center;
		}
		.indicator-item { margin-bottom:10px; }
		.legend { font-size:12px; color:#555; margin-left:20px; }
		.date-label {
			position:absolute; bottom:15px; right:15px;
			background:rgba(0,0,0,0.7); color:white;
			padding:8px 16px; border-radius:6px;
			font-family:sans-serif; font-size:1rem;
			display:none; z-index:1200;
		}
		.legends-container {
			border-top:1px solid #ccc; margin-top:10px; padding-top:6px;
		}
		.legend-item { text-align:center; margin-bottom:10px; }
		.legend-item img {
			width:100%; max-width:320px;
			border:1px solid #ddd; border-radius:6px; background:white;
		}
		
		/* --- Estilos para la Tarjeta de AQI (Popup) --- */
		.aqi-card {
			padding: 10px;
			border-radius: 8px;
			font-family: sans-serif;
			margin-bottom: 8px;
			color: white;
			font-weight: bold;
			text-align: center;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
		}
		.aqi-card h5 {
			margin: 0;
			font-size: 1.1rem;
		}
		.aqi-card-good { background-color: #00cc66; }
		.aqi-card-moderate { background-color: #ffde33; color: #333; }
		.aqi-card-unhealthy_sg { background-color: #ff9933; }
		.aqi-card-unhealthy { background-color: #ff0000; }
		.aqi-card-very_unhealthy { background-color: #990066; }
		.aqi-card-hazardous { background-color: #660000; }

		.pollutant-list {
			font-size: 12px;
			padding-top: 5px;
			color: #333;
		}
		.pollutant-item {
			display: flex;
			justify-content: space-between;
			border-bottom: 1px dotted #ccc;
			padding: 2px 0;
		}
	</style>
</head>
<body>
	<!-- NUEVO PANEL DE CABECERA CON T√çTULO Y DESCRIPCI√ìN -->
	<div id="headerPanel">
		<h1>Air Quality Index (AQI) Viewer</h1>
		<p>Explore real-time air quality monitoring data from AQICN alongside near-real-time atmospheric and Earth observation indicators from NASA's GIBS/TEMPO satellite missions. Use the controls to switch layers, view data legends, and animate temporal trends.</p>
	</div>

	<div id="map"></div>

	<div class="controls">
		<input type="date" id="datePicker" class="custom-button" />
		<button class="custom-button" id="toggleBtn">Switch to street map</button>
		<button class="custom-button" id="indicatorsBtn">Indicators view</button>
		<button id="btnAQICN" class="custom-button">Monitoring points</button>
		<input type="text" id="aqiFilter" class="custom-button" placeholder="Filter region or city" style="display:none;" />
		<button id="btnClearAQI" class="custom-button" style="display:none;">Clear points</button>
	</div>

	<div class="indicators-panel" id="indicatorsPanel">
		<button class="indicators-close" id="closeIndicators">√ó</button>
		<h4>--Indicators--</h4>

		<label for="tempoTimestamp" style="display:block; font-size:13px; margin-bottom:4px;">üïí Select available time:</label>
		<select id="tempoTimestamp" style="width:100%; margin-bottom:10px;">
			<option value="">Select an indicator first</option>
		</select>

		<div id="indicatorsList"></div>
		<hr>

		<h5 style="margin:8px 0 4px;">Animation</h5>
		<label>Start:</label>
		<select id="tempoStart" style="width:100%; margin-bottom:4px;"></select>
		<label>Stop:</label>
		<select id="tempoEnd" style="width:100%; margin-bottom:8px;"></select>
		<button id="startTempoAnim" class="custom-button">Start</button>
		<button id="stopTempoAnim" class="custom-button" disabled>Stop</button>

		<div style="font-size:12px; color:#444; margin-top:8px;">
			Dates are automatically retrieved from the GIBS (NASA) server.
			If no data is available, it may appear empty.
		</div>
		<div class="legends-container" id="legendsContainer"></div>
	</div>

	<div class="date-label" id="dateLabel"></div>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

	<script>
	(async function() {
		// Funci√≥n auxiliar para formatear la fecha a YYYY-MM-DD
		function formatLocalDate(d){
			const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
			return `${y}-${m}-${day}`;
		}

		// Inicializaci√≥n del mapa (centrado en Am√©rica del Sur)
		const map = L.map("map", { center: [-9.2, -75], zoom: 4 });

		// Listener para el bot√≥n de Puntos de Monitoreo AQICN
		document.getElementById("btnAQICN").addEventListener("click", () => {
			loadAQICNMonitoring(map);
		});

		const today = new Date();
		const todayStr = formatLocalDate(today);
		// Hora actual para decidir si mostrar la capa diurna o nocturna por defecto
		const hour = today.getHours();

		// Funci√≥n para crear las capas satelitales de NASA GIBS
		function createLayers(dateStr){
			// Capa diurna: MODIS True Color (Nivel 9)
			const modis = L.tileLayer(
				`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/${dateStr}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpeg`,
				{ maxZoom:9, attribution:"NASA MODIS Terra" }
			);
			// Capa nocturna: VIIRS Day-Night Band (Nivel 8)
			const viirs = L.tileLayer(
				`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_DayNightBand_At_Sensor_Radiance/default/${dateStr}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png`,
				{ maxZoom:8, attribution:"NASA VIIRS" }
			);
			return { modis, viirs };
		}

		let { modis, viirs } = createLayers(todayStr);
		const streets = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19});
		// Determinar la capa satelital inicial (d√≠a: MODIS, noche: VIIRS)
		let satelliteLayer = (hour >= 6 && hour < 18) ? modis : viirs;
		satelliteLayer.addTo(map);

		let showingStreets = false;
		const btn = document.getElementById("toggleBtn");
		const datePicker = document.getElementById("datePicker");
		datePicker.value = todayStr;
		datePicker.max = todayStr;

		// Funci√≥n para cambiar suavemente a la nueva capa satelital (si se cambia la fecha)
		async function fadeToNewLayer(dateStr){
			const newLayers = createLayers(dateStr);
			const nextLayer = (hour >= 6 && hour < 18) ? newLayers.modis : newLayers.viirs;

			// Implementar un efecto de fade out (m√°s simple que el de los indicadores)
			if(map.hasLayer(satelliteLayer)) map.removeLayer(satelliteLayer);

			nextLayer.addTo(map);
			satelliteLayer = nextLayer;
			updateIndicatorLayers(selectedIso); // Asegurar que los indicadores usen la nueva fecha
		}

		// Evento para alternar entre mapa satelital y de calles
		btn.addEventListener("click", () => {
			if(showingStreets){
				map.removeLayer(streets);
				map.addLayer(satelliteLayer);
				btn.textContent="Switch to street map";
				showingStreets=false;
			} else {
				map.removeLayer(satelliteLayer);
				map.addLayer(streets);
				btn.textContent="Switch to satellite map";
				showingStreets=true;
			}
		});

		// Evento para el cambio de fecha
		datePicker.addEventListener("change", () => {
			if(datePicker.value) fadeToNewLayer(datePicker.value);
		});

		// === Indicadores TEMPO (NASA GIBS) ===
		const indicatorsBtn = document.getElementById("indicatorsBtn");
		const indicatorsPanel = document.getElementById("indicatorsPanel");
		const closeIndicators = document.getElementById("closeIndicators");
		const timestampSelect = document.getElementById("tempoTimestamp");
		const tempoStart = document.getElementById("tempoStart");
		const tempoEnd = document.getElementById("tempoEnd");
		const startTempoAnim = document.getElementById("startTempoAnim");
		const stopTempoAnim = document.getElementById("stopTempoAnim");
		const indicatorsList = document.getElementById("indicatorsList");
		const legendsContainer = document.getElementById("legendsContainer");
		const dateLabel = document.getElementById("dateLabel");

		// Definici√≥n de las capas TEMPO y otras de GIBS
		const validIndicators = [
			{ id:"TEMPO_L3_Formaldehyde_Vertical_Column", name:"Formaldehyde (L3, Vertical Column, Subdaily, TEMPO)", legend:"https://gibs.earthdata.nasa.gov/legends/TEMPO_HCHO_Vertical_Column_H.svg" },
			{ id:"TEMPO_L3_NO2_Vertical_Column_Troposphere", name:"Nitrogen Dioxide (L3, Troposphere Column, Subdaily, TEMPO)", legend:"https://gibs.earthdata.nasa.gov/legends/TEMPO_NO2_Vertical_Column_Troposphere_H.svg" },
			{ id:"TEMPO_L3_Ozone_Profile_Troposphere_Column", name:"Ozone Profile (L3, Troposphere Column, Subdaily, TEMPO)", legend:"https://gibs.earthdata.nasa.gov/legends/TEMPO_Troposphere_Ozone_Column_H.svg" },
			{ id:"TEMPO_L3_Cloud_Cloud_Pressure_Total", name:"Clouds (L3, Cloud Pressure Total, Subdaily, TEMPO)", legend:"https://gibs.earthdata.nasa.gov/legends/TEMPO_Cloud_Cloud_Pressure_Total_H.svg" },
			{ id:"GHRSST_L4_MUR_Sea_Surface_Temperature", name:"Sea Surface Temperature (L4, MUR Global Foundation, GHRSST)", legend:"https://gibs.earthdata.nasa.gov/legends/GHRSST_Sea_Surface_Temperature_H.svg" }
		];

		let indicatorLayers = {};
		let selectedIso = null;
		let tempoTimes = [];
		let tempoTimer = null;

		// Cargar las marcas de tiempo disponibles desde el WMTS Capabilities XML
		async function loadTimesForLayer(layerId){
			try {
				const res = await fetch("https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/1.0.0/WMTSCapabilities.xml");
				const text = await res.text();
				const xml = new DOMParser().parseFromString(text, "application/xml");
				
				// Usar selectores que manejen namespaces (ows:Identifier)
				const node = [...xml.querySelectorAll("Layer")].find(l => {
					// Buscar Identifier sin depender del prefijo de namespace (m√°s robusto)
					const idNode = l.querySelector("Identifier");
					return idNode && idNode.textContent.trim() === layerId;
				});

				if(!node) return [];
				
				// Buscar la dimensi√≥n de tiempo
				const dim = node.querySelector("Dimension");
				if(!dim) return [];
				
				// Extraer todos los valores de tiempo (Time values)
				const values = [...dim.querySelectorAll("Value")]
					.map(v => v.textContent.match(/^([^/]+)/)?.[1]) // Solo necesitamos la parte de la fecha/hora
					.filter(Boolean);
				
				// Eliminar duplicados (si existieran)
				return [...new Set(values)]; 
			} catch(e){ 
				console.error("Error al cargar tiempos de la capa:", e); 
				return []; 
			}
		}

		// Rellenar los selectores de tiempo (tiempo individual y rangos de animaci√≥n)
		async function updateTimestampSelectorFor(layerId){
			timestampSelect.innerHTML='<option>Loading...</option>';
			tempoStart.innerHTML=""; tempoEnd.innerHTML="";
			
			const times = await loadTimesForLayer(layerId);
			tempoTimes = times;
			timestampSelect.innerHTML="";

			if(times.length===0){
				timestampSelect.innerHTML='<option value="">No available times</option>';
				return;
			}
			
			// Rellenar el selector de tiempo individual
			times.forEach(t=>{
				const o=document.createElement("option");
				o.value=t; o.textContent=t; timestampSelect.appendChild(o);
			});
			selectedIso = times[times.length-1]; // Seleccionar el m√°s reciente
			timestampSelect.value = selectedIso;
			
			// Rellenar los selectores de animaci√≥n
			times.forEach(t=>{
				const a=document.createElement("option");
				a.value=t; a.textContent=t;
				tempoStart.appendChild(a.cloneNode(true));
				tempoEnd.appendChild(a);
			});
			// Seleccionar el rango completo por defecto
			tempoStart.value=times[0];
			tempoEnd.value=times[times.length-1];
		}

		// Funciones de Leyenda
		function addLegend(id,url,name){
			const div=document.createElement("div");
			div.className="legend-item";
			div.id=`legend_${id}`;
			div.innerHTML=`<strong>${name}</strong><br><img src="${url}" alt="${name}">`;
			legendsContainer.appendChild(div);
		}

		function removeLegend(id){
			const el=document.getElementById(`legend_${id}`);
			if(el) el.remove();
		}

		// Creaci√≥n de la lista de indicadores y manejo de checkboxes
		validIndicators.forEach(ind=>{
			const div=document.createElement("div");
			div.className="indicator-item";
			div.innerHTML=`<label><input type="checkbox" id="${ind.id}"> ${ind.name}</label>
						 <div class="legend">üõ∞Ô∏è ${ind.id}</div>`;
			indicatorsList.appendChild(div);
			const checkbox=div.querySelector("input");
			
			checkbox.addEventListener("change", async e=>{
				const id=ind.id;
				if(e.target.checked){
					// Si se selecciona, cargar tiempos y a√±adir capa
					await updateTimestampSelectorFor(ind.id);
					if(!selectedIso){
						// Usar un modal o un mensaje de error en lugar de alert()
						alert("No available times for this layer."); 
						e.target.checked = false; // Desmarcar si falla
						return;
					} 
					indicatorLayers[id] = L.tileLayer(
						// El nivel 7 es un buen compromiso para TEMPO
						`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${id}/default/${selectedIso}/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`,
						{ maxZoom:9, opacity:0.8, attribution:"NASA GIBS", pane: 'overlayPane' } // Usar 'overlayPane' para superposici√≥n
					).addTo(map);
					addLegend(id, ind.legend, ind.name);
				} else if(indicatorLayers[id]){
					// Si se deselecciona, remover capa y leyenda
					map.removeLayer(indicatorLayers[id]);
					delete indicatorLayers[id];
					removeLegend(id);
				}
			});
		});

		// Evento para cambiar el tiempo (timestamp) de los indicadores activos
		timestampSelect.addEventListener("change", ()=>{
			selectedIso=timestampSelect.value;
			updateIndicatorLayers(selectedIso);
		});

		// Funci√≥n principal para actualizar las capas de indicadores (con efecto de fade)
		function updateIndicatorLayers(iso){
			for(const id in indicatorLayers){
				if(map.hasLayer(indicatorLayers[id])){
					const oldLayer=indicatorLayers[id];
					
					// Crear la nueva capa con opacidad 0
					const newLayer=L.tileLayer(
						`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${id}/default/${iso}/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`,
						{maxZoom:9,opacity:0, attribution:"NASA GIBS", pane: 'overlayPane'}
					);
					
					newLayer.addTo(map);
					
					// Animaci√≥n de fade
					let opacity=0;
					const fadeInterval=setInterval(()=>{
						opacity+=0.05; // Velocidad del fade
						newLayer.setOpacity(opacity);
						oldLayer.setOpacity(1-opacity);
						
						if(opacity>=1){
							clearInterval(fadeInterval);
							map.removeLayer(oldLayer);
							indicatorLayers[id]=newLayer;
						}
					},50); // 50ms por frame
				}
			}
		}

		// L√≥gica de Animaci√≥n TEMPO
		startTempoAnim.addEventListener("click", ()=>{
			if(Object.keys(indicatorLayers).length === 0){
				alert("Select a gas first."); // Mantengo alert aqu√≠ para mantener la funci√≥n original, pero se recomienda un modal.
				return;
			}
			
			const i1=tempoTimes.indexOf(tempoStart.value);
			const i2=tempoTimes.indexOf(tempoEnd.value);
			
			if(i1===-1||i2===-1){alert("Select valid dates."); return;}
			
			// Crear el subconjunto de tiempos para la animaci√≥n
			const startIdx = Math.min(i1, i2);
			const endIdx = Math.max(i1, i2);
			let subset=tempoTimes.slice(startIdx, endIdx + 1);
			
			if(subset.length===0){alert("Empty range."); return;}
			
			clearInterval(tempoTimer);
			let idx=0;
			
			startTempoAnim.disabled=true;
			stopTempoAnim.disabled=false;
			dateLabel.style.display="block";
			
			function animate(){
				const t=subset[idx];
				selectedIso=t;
				updateIndicatorLayers(t);
				dateLabel.textContent=`üïí ${t}`;
				idx++;
				if(idx>=subset.length) idx=0; // Bucle
			}
			
			animate();
			tempoTimer=setInterval(animate,2000); // Velocidad de animaci√≥n
		});

		stopTempoAnim.addEventListener("click", ()=>{
			clearInterval(tempoTimer);
			tempoTimer=null;
			dateLabel.style.display="none";
			startTempoAnim.disabled=false;
			stopTempoAnim.disabled=true;
		});

		// Eventos para mostrar/ocultar el panel de indicadores
		indicatorsBtn.addEventListener("click",()=>{
			indicatorsPanel.style.display = indicatorsPanel.style.display==="none"?"block":"none";
		});
		closeIndicators.addEventListener("click",()=>{ indicatorsPanel.style.display="none"; });
	})();
	</script>

	<!-- MONITORING POINTS (AQICN) - MODIFIED BLOCK -->
	<script>
	let allMarkers = {};
	let aqiControlsVisible = false;

	// Funci√≥n para generar la tarjeta flotante interactiva seg√∫n el AQI
	function getAqiCardHtml(aqi, name) {
		let category = "Unknown";
		let className = "aqi-card-good";
		let recommendation = "Data is unavailable or invalid.";

		if (aqi > 0 && aqi <= 50) {
			category = "GOOD";
			className = "aqi-card-good";
			recommendation = "Air quality is good. It's safe to enjoy outdoor activities.";
		} else if (aqi > 50 && aqi <= 100) {
			category = "MODERATE";
			className = "aqi-card-moderate";
			recommendation = "Air quality is acceptable. Sensitive groups should consider reducing prolonged outdoor exertion.";
		} else if (aqi > 100 && aqi <= 150) {
			category = "UNHEALTHY for Sensitive Groups";
			className = "aqi-card-unhealthy_sg";
			recommendation = "Sensitive individuals should limit time outdoors. Others are generally safe.";
		} else if (aqi > 150 && aqi <= 200) {
			category = "UNHEALTHY";
			className = "aqi-card-unhealthy";
			recommendation = "Everyone may experience health effects. Limit prolonged outdoor exposure.";
		} else if (aqi > 200 && aqi <= 300) {
			category = "VERY UNHEALTHY";
			className = "aqi-card-very_unhealthy";
			recommendation = "Health warnings of emergency conditions. Everyone should avoid outdoor exertion.";
		} else if (aqi > 300) {
			category = "HAZARDOUS";
			className = "aqi-card-hazardous";
			recommendation = "Health alert! The entire population is likely to be affected. Stay indoors.";
		}
		
		const cardHtml = `
			<div class="${className} aqi-card">
				<h5>AQI: ${aqi} - ${category}</h5>
				<p style="font-size:11px; margin:0; padding-top:3px;">${recommendation}</p>
			</div>
			<div style="font-family:sans-serif; font-size:14px; margin-bottom:5px;">
				<b>Location:</b> ${name}
			</div>
		`;

		return cardHtml;
	}


	function loadAQICNMonitoring(map) {
		const filterInput = document.getElementById("aqiFilter");
		const clearBtn = document.getElementById("btnClearAQI");
		const toggleBtn = document.getElementById("btnAQICN");

		// Mostrar u ocultar controles y cambiar estado del bot√≥n
		if (!aqiControlsVisible) {
			filterInput.style.display = "block";
			clearBtn.style.display = "block";
			toggleBtn.textContent = "Hide monitoring points";
			aqiControlsVisible = true;
		} else {
			removeAQIMarkers(map);
			filterInput.value = "";
			filterInput.style.display = "none";
			clearBtn.style.display = "none";
			toggleBtn.textContent = "Monitoring points";
			aqiControlsVisible = false;
		}

		// Si se ocultan, terminamos aqu√≠
		if (!aqiControlsVisible) return;

		// Si ya hay puntos, no los recargamos a menos que el mapa se mueva o se borren
		if (Object.keys(allMarkers).length > 0) return;

		const token = "090ca286c1bb00d992871976d77c05b6347a17d1"; // AQICN demo token
		const bounds = map.getBounds();
		// Formato de l√≠mites: latN,lngW,latS,lngE
		const boundsString = `${bounds.getNorth()},${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()}`;
		
		toggleBtn.textContent = "Loading...";

		fetch(`https://api.waqi.info/v2/map/bounds/?latlng=${boundsString}&token=${token}`)
			.then(res => res.json())
			.then(data => {
				toggleBtn.textContent = "Hide monitoring points";
				if (data.status !== "ok") throw new Error(data.data);
				removeAQIMarkers(map, false); 

				data.data.forEach(station => {
					const iw = 83, ih = 107;
					// √çcono din√°mico seg√∫n el AQI
					const icon = L.icon({
						iconUrl: `https://waqi.info/mapicon/${station.aqi}.30.png`,
						iconSize: [iw / 2, ih / 2],
						iconAnchor: [iw / 4, ih / 2 - 5],
					});
					
					const marker = L.marker([station.lat, station.lon], {
						icon,
						title: station.station.name,
					}).addTo(map);

					// Cargar informaci√≥n detallada al hacer clic
					marker.on("click", () => {
						fetch(`https://api.waqi.info/feed/@${station.uid}/?token=${token}`)
							.then(r => r.json())
							.then(info => {
								if (info.status !== "ok") return;
								const m = info.data;

								// 1. Generar la tarjeta de recomendaci√≥n interactiva
								let popupHtml = getAqiCardHtml(m.aqi, m.city.name);
								
								// 2. A√±adir la informaci√≥n detallada (contaminantes)
								let detailedHtml = `<small style="display:block; text-align:right;">Updated: ${new Date(m.time.v * 1000).toLocaleTimeString()}</small>`;
								
								if (m.iaqi) {
									detailedHtml += "<hr style='margin:4px 0 6px 0;'>";
									detailedHtml += "<div class='pollutant-list'><b>Key Pollutants:</b>";
									
									// Mostrar contaminantes relevantes
									const pollutantsToShow = ['pm25', 'pm10', 'o3', 'no2', 'so2', 'co'];
									pollutantsToShow.forEach(p => {
										if (m.iaqi[p] && m.iaqi[p].v !== undefined) {
											detailedHtml += `<div class="pollutant-item"><span>${p.toUpperCase()}:</span> <b>${m.iaqi[p].v}</b></div>`;
										}
									});
									detailedHtml += `</div>`;
								}

								// Combinar tarjeta + detalles
								marker.bindPopup(`<div style="max-width:240px; padding:0;">${popupHtml}${detailedHtml}</div>`).openPopup();
							});
					});
					allMarkers[station.uid] = marker;
				});

				// Filtro din√°mico por texto (se mantiene)
				filterInput.oninput = () => {
					const term = filterInput.value.toLowerCase();
					Object.values(allMarkers).forEach(m => {
						const name = m.options.title.toLowerCase();
						if (name.includes(term)) {
							if (!map.hasLayer(m)) m.addTo(map);
						} else {
							if (map.hasLayer(m)) map.removeLayer(m);
						}
					});
				};

				// Bot√≥n para eliminar todos los marcadores y ocultar el filtro
				clearBtn.onclick = () => {
					removeAQIMarkers(map, true);
					filterInput.value = "";
					filterInput.style.display = "none";
					clearBtn.style.display = "none";
					toggleBtn.textContent = "Monitoring points";
					aqiControlsVisible = false;
				};
			})
			.catch(err => {
				toggleBtn.textContent = "Monitoring points (Error)";
				console.error("Error loading AQICN data:", err);
				// Usar un modal en un entorno real
				alert("Failed to load AQI monitoring points. Try again later or check console.");
			});
	}

	// Funci√≥n para eliminar marcadores
	function removeAQIMarkers(map, clearAll = false) {
		for (const uid in allMarkers) {
			if (map.hasLayer(allMarkers[uid])) {
				map.removeLayer(allMarkers[uid]);
			}
		}
		if (clearAll) {
			allMarkers = {};
		}
	}
	</script>
</body>
</html>
